use field::FE;
use std::mem;

static ROUND_CONSTANTS: [FE; 128] = [
    FE::from_words(
        589684135938649225,
        11820040416388919760,
        1376283091369227076,
        2611923443488327891,
    ),
    FE::from_words(
        6153749223229089211,
        6589409025734818568,
        9344028487550380594,
        3004217988136997522,
    ),
    FE::from_words(
        1959575445103474295,
        10474509770155941266,
        4466414212272085822,
        8036857563524218817,
    ),
    FE::from_words(
        7785721969510921240,
        2318510075158005585,
        13966196729571205471,
        1947111705775631379,
    ),
    FE::from_words(
        513337866211813714,
        3754166009379426153,
        11944237166180518432,
        5310308824106754180,
    ),
    FE::from_words(
        13682542232822380571,
        17148616913844231862,
        10733999990558134774,
        3737339155303735340,
    ),
    FE::from_words(
        7097925233868806103,
        11160837829174823967,
        1080375511472225826,
        7453523619065985947,
    ),
    FE::from_words(
        17621177671224146232,
        458874915608602493,
        11804950363876150503,
        996076188909006904,
    ),
    FE::from_words(
        9361020873407154642,
        13560685239058331457,
        7442876776832053702,
        1404395409790998000,
    ),
    FE::from_words(
        15842619657988634060,
        10130534747718702171,
        8571303987200721413,
        2190583953426771475,
    ),
    FE::from_words(
        12969805325836834218,
        14384288744345738773,
        4371793681537583731,
        584497953891271760,
    ),
    FE::from_words(
        3938391022169347958,
        7220021107472086871,
        3102131635507821328,
        5085980577684595695,
    ),
    FE::from_words(
        9918693403450101259,
        8837847145192416974,
        14206497819676986118,
        3516989144867839013,
    ),
    FE::from_words(
        14569553721196676311,
        7330215946069049687,
        16891652030395137469,
        2834864574223549528,
    ),
    FE::from_words(
        10191192885496246325,
        1128392165276602522,
        15020150528256834951,
        8684835444506882838,
    ),
    FE::from_words(
        11667974389867774150,
        4203414508849508194,
        16103420332344483743,
        343329789851287162,
    ),
    FE::from_words(
        1187023098395006982,
        3177238595238285535,
        6032300118875148799,
        69577303574957377,
    ),
    FE::from_words(
        14834941682935922694,
        18024993210564543830,
        14719259147346374922,
        306833590568646209,
    ),
    FE::from_words(
        9811514275877492732,
        7166618988503459502,
        14426788900617630045,
        5828121332348474825,
    ),
    FE::from_words(
        16131744828588997941,
        8557176347615578700,
        1853953936851825309,
        7932911925753532815,
    ),
    FE::from_words(
        11143331797397392686,
        2132723442311472001,
        17334917921776370242,
        5718461668229097789,
    ),
    FE::from_words(
        10303130679755187235,
        6004036595294995738,
        824586376247665001,
        3694825675770731167,
    ),
    FE::from_words(
        17652541658812570245,
        6332842951335887378,
        11859862793273461078,
        2464231901545749828,
    ),
    FE::from_words(
        8302467643728445059,
        13305475649754687825,
        16145755809802593459,
        8681927963534191861,
    ),
    FE::from_words(
        10433649430919115378,
        6702868190790416495,
        618405422502708969,
        4739129520212395237,
    ),
    FE::from_words(
        15444751012524346049,
        6311389979745764278,
        10823111034247731631,
        3537618885898285907,
    ),
    FE::from_words(
        9444965660343511625,
        10366479449116666033,
        2785123810212494896,
        2544267248855985212,
    ),
    FE::from_words(
        11268977406562345499,
        3232157206104500639,
        4267426487950468128,
        2982195780567751679,
    ),
    FE::from_words(
        1010715136524380447,
        7269707648726737364,
        1988022121839804742,
        8831163311868801142,
    ),
    FE::from_words(
        8397256512377890008,
        5616233716914642588,
        5290564672909854680,
        1292188240626934109,
    ),
    FE::from_words(
        2006358845409017280,
        11803547459574466492,
        3714502459923343407,
        5339315718713884148,
    ),
    FE::from_words(
        15625897123714706189,
        3630396590358132495,
        9488478420242092785,
        8353364281449953718,
    ),
    FE::from_words(
        2097499299632845646,
        15016595644893047000,
        12282337007133832843,
        1595487558118311769,
    ),
    FE::from_words(
        5124086761069971430,
        18355988600350625551,
        6452096321721974157,
        1137574199021437411,
    ),
    FE::from_words(
        14197087380795148142,
        18219759503974829984,
        6020463255244065122,
        5140141611049132978,
    ),
    FE::from_words(
        3315032225951243299,
        12336928545701071451,
        7348788105424467821,
        8198713785539680081,
    ),
    FE::from_words(
        12306862611865460282,
        14536494936216398275,
        8892469709972433691,
        6200367709664486421,
    ),
    FE::from_words(
        3480767064592239081,
        13975389551599570908,
        12751934643920506875,
        3353306442635271095,
    ),
    FE::from_words(
        332171593889436073,
        13191613766138529098,
        11517361458135492565,
        3053374420943422046,
    ),
    FE::from_words(
        9325831210573773793,
        14416372843399033994,
        11555846893292288026,
        4249402456665308341,
    ),
    FE::from_words(
        8723403423762160051,
        12107078838717547980,
        8654550683357804457,
        8483098978560131259,
    ),
    FE::from_words(
        7899380340274543258,
        10502761457200989517,
        13683490436986369510,
        6029657962043988835,
    ),
    FE::from_words(
        5266208567226797203,
        13058479505928639081,
        18399074963675404660,
        4189662037963002001,
    ),
    FE::from_words(
        14585374485638993663,
        1177409617075594024,
        4714395384956505609,
        6987450231930982242,
    ),
    FE::from_words(
        5467962787925607114,
        17301369011487676673,
        6147486890306293037,
        5265294624914097806,
    ),
    FE::from_words(
        10434077761474603553,
        17274310642739586073,
        10943853506177503820,
        7195162499966684947,
    ),
    FE::from_words(
        5326031378048464484,
        11493213006030385537,
        6198538158733417061,
        2122366033560697633,
    ),
    FE::from_words(
        7466129446621731306,
        17188359255118174330,
        12649960904120739934,
        588801264936546268,
    ),
    FE::from_words(
        14148029818977172492,
        17154723613758577652,
        14213500959795018867,
        4815825609718803470,
    ),
    FE::from_words(
        1432971852551328381,
        8498205712002154011,
        11457303303388743499,
        8444107440446000468,
    ),
    FE::from_words(
        12681249175628915622,
        14490142765875723403,
        14072065159601061619,
        210031201234912493,
    ),
    FE::from_words(
        13319464777485866790,
        7305650826875757538,
        8430642464030858028,
        5853376578924159013,
    ),
    FE::from_words(
        16862136975399222827,
        15200301053347342470,
        14891077919660325370,
        7947219140477863012,
    ),
    FE::from_words(
        12713733994544103656,
        7357734457994150342,
        17609277166185647527,
        813430715844436788,
    ),
    FE::from_words(
        5568996598675781842,
        5955127701173236611,
        3186199050172131238,
        262255020025191290,
    ),
    FE::from_words(
        13825531051331927500,
        7741730386677545105,
        894879285762049516,
        1162400625872704111,
    ),
    FE::from_words(
        925176570391890800,
        6228916883024052689,
        1788263208544148243,
        5639770407326148600,
    ),
    FE::from_words(
        8955758018280509229,
        5531312386415614921,
        290160052554257793,
        2547261290211698557,
    ),
    FE::from_words(
        7162928250182272081,
        1220498152434831764,
        2598435909776167227,
        8748168371428851132,
    ),
    FE::from_words(
        13635842354786809334,
        8765418863208997403,
        11713211092848926769,
        422944214215784403,
    ),
    FE::from_words(
        378526081953589070,
        12407300691448745544,
        13330769412966677088,
        1200258021945017832,
    ),
    FE::from_words(
        7723538114869319764,
        11874602454253599182,
        7378722009586093783,
        2181988333900642128,
    ),
    FE::from_words(
        4534267638999379842,
        15603222946697874991,
        7331123922749270608,
        891137428318551985,
    ),
    FE::from_words(
        13629158675686406660,
        14463861258819861885,
        6175281312577992203,
        4784416173916906683,
    ),
    FE::from_words(
        8376905373550646973,
        13455831143686907967,
        16559742871857967334,
        8155043300459051659,
    ),
    FE::from_words(
        11067328420609657052,
        6411272093871754453,
        18352228597147538165,
        6277805016933924659,
    ),
    FE::from_words(
        7298259439519942581,
        4692455129906920294,
        7720788497178780209,
        8057534922216754395,
    ),
    FE::from_words(
        12340043792177198606,
        14673428702407243251,
        3653640608095304098,
        5332396357401115257,
    ),
    FE::from_words(
        14379293893748975651,
        8591363569407963592,
        6716140257416171998,
        7470702126096213345,
    ),
    FE::from_words(
        4689179770524101896,
        13361748981796652258,
        11480788988235585567,
        6453937799165199367,
    ),
    FE::from_words(
        3658612047275444557,
        15570907798613206025,
        1755528294279696512,
        2994276127672660405,
    ),
    FE::from_words(
        16622191409945350155,
        5296718210851531342,
        6911807313386780603,
        3426274483819356377,
    ),
    FE::from_words(
        9982783247475910061,
        13552487916389034076,
        15912082647692049547,
        7657758977243841898,
    ),
    FE::from_words(
        17595773234474111654,
        2987922243129670775,
        10096084637655682731,
        1926877606992831380,
    ),
    FE::from_words(
        9970024331672796070,
        14280998139203862819,
        9635613623077620387,
        5313883041741345243,
    ),
    FE::from_words(
        9016636322017356857,
        14243115161215075997,
        1045686779967465889,
        7411136492073156738,
    ),
    FE::from_words(
        209966866202750046,
        508771738160106460,
        12525938445996179513,
        2074515162952284177,
    ),
    FE::from_words(
        7008797471179617678,
        18117184958383176923,
        17186310242917747485,
        5270961695526196786,
    ),
    FE::from_words(
        6387006949495605297,
        5647392402460658148,
        2308818015411069503,
        7178307451157013604,
    ),
    FE::from_words(
        14744935657565135958,
        8737075618347840851,
        3706027440483965361,
        6444889771479652801,
    ),
    FE::from_words(
        13342276381809943121,
        7162586310256208424,
        8410982204675993950,
        8763866420114037132,
    ),
    FE::from_words(
        15314839973398312972,
        15201514098786329685,
        15022948440726869860,
        1209739939428453222,
    ),
    FE::from_words(
        252913871740128752,
        3104318661837541426,
        2595534797978131914,
        799217260477553235,
    ),
    FE::from_words(
        12204963687889920744,
        7900798084728110312,
        9181569710132428343,
        1438723637667462523,
    ),
    FE::from_words(
        17038065341505037010,
        14148000740243361802,
        15699399113247216118,
        5724447341005885835,
    ),
    FE::from_words(
        9561540076916983507,
        4078428460632112726,
        6093471091924965349,
        7063477422300840398,
    ),
    FE::from_words(
        14691766071360495034,
        13809900151099226976,
        13736670045941867353,
        5487712697642825466,
    ),
    FE::from_words(
        14388447116901394561,
        17301349180718119952,
        10008573829969809919,
        8535511592055982100,
    ),
    FE::from_words(
        6729745662030135638,
        14406744422296550431,
        2067963451175624374,
        4885445607703957001,
    ),
    FE::from_words(
        14444585820799018691,
        6369962797091599210,
        10972927051435612047,
        8157258503708936382,
    ),
    FE::from_words(
        4166495770831274834,
        11296630493484029360,
        7574998442637964314,
        223811847596531045,
    ),
    FE::from_words(
        6512374935315635436,
        15824269225538830882,
        14038516314317752574,
        4639303148507558662,
    ),
    FE::from_words(
        9984935664166262023,
        3476620012480176811,
        9161862843894989023,
        8160953727837858168,
    ),
    FE::from_words(
        4694552688225052994,
        13859595855299458947,
        12958315331723116737,
        1684246314647580218,
    ),
    FE::from_words(
        17076081879990546526,
        11754531295710361959,
        15089942657400333818,
        1051582889049332121,
    ),
    FE::from_words(
        14774049922305496252,
        3318742451925751993,
        5375609093569239260,
        6222807553728777799,
    ),
    FE::from_words(
        16612872106207817071,
        16694787594675815807,
        6871587407767921110,
        8834353781353923665,
    ),
    FE::from_words(
        5720507680583871448,
        13547858348448217811,
        7673207955406515978,
        5902961944678647466,
    ),
    FE::from_words(
        9060599177151989687,
        14968158881324012002,
        263290729183031017,
        4546488972462251391,
    ),
    FE::from_words(
        151113239920319381,
        1473989652518588652,
        4570919221399114774,
        8090445995849346381,
    ),
    FE::from_words(
        9998149865343098524,
        2311150709106228996,
        13734302048294266667,
        1375200434520094114,
    ),
    FE::from_words(
        196139754575052514,
        16148393035107533432,
        18386740157525584239,
        6859649541068132456,
    ),
    FE::from_words(
        14640908300821630729,
        6538500009304397,
        6351838579504761810,
        4328858821344299656,
    ),
    FE::from_words(
        8983907576092851059,
        13602111785002129030,
        18058875915529586388,
        2387006922670553992,
    ),
    FE::from_words(
        5635504055554829055,
        1202052189843883911,
        7194920879685424774,
        3245749623484657032,
    ),
    FE::from_words(
        15471821057934676423,
        15669546818723503782,
        417984686014977681,
        8825458673079836329,
    ),
    FE::from_words(
        10516685290047769354,
        6124180975233432995,
        10138283722790386382,
        6101692486179167427,
    ),
    FE::from_words(
        11569543968198636307,
        15147547733468299238,
        5410684687337284897,
        7973533245772268838,
    ),
    FE::from_words(
        13633957622452217882,
        17560131483068155725,
        8234621758392383705,
        818504569202750761,
    ),
    FE::from_words(
        17318503431984606622,
        15437391223379422309,
        12325504659181432463,
        4806089176289679880,
    ),
    FE::from_words(
        7602088582619058777,
        12299895899989900098,
        13548196106608312966,
        8100768670866124209,
    ),
    FE::from_words(
        4366702549797606604,
        13069804230476548960,
        13109937334829752905,
        6215137505118617104,
    ),
    FE::from_words(
        5424985782953568149,
        12878073096861304497,
        11716719693771132439,
        4313520557714746696,
    ),
    FE::from_words(
        4485592027364138969,
        17959191654716527780,
        7865833667462689686,
        6964021291479551617,
    ),
    FE::from_words(
        12367675061504675532,
        16010137083215352817,
        11788750088104232014,
        2114132978550821573,
    ),
    FE::from_words(
        5202686001242300952,
        12493418489135625563,
        9144707174557970668,
        1741761174250451213,
    ),
    FE::from_words(
        10519798834619898464,
        10383712581008930202,
        12105152848644997691,
        635125887863342663,
    ),
    FE::from_words(
        17619126991555735986,
        12502367603143333902,
        17721084289558046145,
        6310523021155150170,
    ),
    FE::from_words(
        14504244348115772481,
        4825637157153661418,
        3965996744220601774,
        4239465287258644819,
    ),
    FE::from_words(
        16880789103316953619,
        7409274234505728218,
        14889724858939125623,
        3890875524732822229,
    ),
    FE::from_words(
        12785997581600856013,
        7357748650341660767,
        3685935214283665069,
        2593036642535784306,
    ),
    FE::from_words(
        11155579791691393905,
        8517003513521214320,
        9314669704441659964,
        9021836368784607880,
    ),
    FE::from_words(
        12878868432919737700,
        13914984466099463498,
        18034182997006844822,
        1472451283486345491,
    ),
    FE::from_words(
        5101173152628984536,
        4677517670329616446,
        1995078940087765860,
        1127548445858441649,
    ),
    FE::from_words(
        7019760136624446688,
        6751364530041582041,
        11009220082752403214,
        145726695133331085,
    ),
    FE::from_words(
        6074166680869815880,
        15605573951792856060,
        2722890586949403181,
        1169036964402949776,
    ),
    FE::from_words(
        4821868683498187578,
        9005271298628814401,
        1753821982851043153,
        811041401928550967,
    ),
    FE::from_words(
        5553880577021771550,
        6665796524408124267,
        12173245788716869267,
        209405424577621477,
    ),
];

pub fn cipher1(mut chain: FE, key: &[FE]) -> FE {
    assert_eq!(key.len(), 32);
    for i in 0..128 {
        chain += ROUND_CONSTANTS[i] + key[i & 31];
        chain *= chain.square();
    }
    chain
}

#[inline(never)]
pub fn cipher2(chains: [&mut FE; 2], keys: [&[FE]; 2]) {
    let mut ca = *chains[0];
    let mut cb = *chains[1];
    let ka = keys[0];
    let kb = keys[1];
    assert_eq!(ka.len(), 32);
    assert_eq!(kb.len(), 32);
    for i in 0..128 {
        ca += ROUND_CONSTANTS[i] + ka[i & 31];
        ca *= ca.square();
        cb += ROUND_CONSTANTS[i] + kb[i & 31];
        cb *= cb.square();
    }
    *chains[0] = ca;
    *chains[1] = cb;
}

#[cfg(test)]
mod test {
    use super::*;
    use test::Bencher;

    #[bench]
    fn bench_cipher1(b: &mut Bencher) {
        let vc = [FE::one(); 32];
        b.bytes = mem::size_of_val(&vc) as u64;
        b.iter(|| cipher1(FE::zero(), &vc));
    }

    #[bench]
    fn bench_cipher4(b: &mut Bencher) {
        let vc = [FE::one(); 32];
        let mut ch = (FE::zero(), FE::zero());
        b.bytes = 2 * mem::size_of_val(&vc) as u64;
        b.iter(|| cipher2([&mut ch.0, &mut ch.1], [&vc; 2]));
    }
}
